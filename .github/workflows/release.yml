# =============================================================================
# SDKs Release — Publish all SDKs on version tag
# =============================================================================
# Triggered by pushing a version tag (e.g. v0.2.0).
# Syncs version across all SDKs, runs tests, publishes to registries,
# and creates a GitHub Release.
#
# Required secrets:
#   NPM_TOKEN               — npm publish token for @ucotron/sdk
#   PYPI_API_TOKEN           — PyPI API token for ucotron-sdk
#   SONATYPE_USERNAME        — Maven Central (Sonatype OSSRH) username
#   SONATYPE_PASSWORD        — Maven Central (Sonatype OSSRH) password
#   GPG_SIGNING_KEY          — GPG private key for Maven Central signing
#   GPG_SIGNING_PASSWORD     — GPG passphrase
#   PACKAGIST_USERNAME       — Packagist username for PHP package
#   PACKAGIST_TOKEN          — Packagist API token
# =============================================================================

name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  VERSION: ${{ github.ref_name }}

jobs:
  # ── Sync version across all SDKs ─────────────────────────────────────────
  sync-version:
    name: Sync version
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.parse.outputs.semver }}
    steps:
      - uses: actions/checkout@v4

      - name: Parse version from tag
        id: parse
        run: |
          SEMVER="${VERSION#v}"
          echo "semver=${SEMVER}" >> "$GITHUB_OUTPUT"
          echo "Release version: ${SEMVER}"

  # ── Publish TypeScript to npm ────────────────────────────────────────────
  publish-typescript:
    name: Publish TypeScript → npm
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Set version & publish
        working-directory: typescript
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm version "${{ needs.sync-version.outputs.semver }}" --no-git-tag-version
          npm ci
          npm run build
          npm run test:ci
          npm publish --access public

  # ── Publish Python to PyPI ───────────────────────────────────────────────
  publish-python:
    name: Publish Python → PyPI
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set version, build & publish
        working-directory: python
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          sed -i "s/version = \".*\"/version = \"${{ needs.sync-version.outputs.semver }}\"/" pyproject.toml
          pip install build twine
          pip install -e ".[dev]"
          pytest --tb=short
          python -m build
          twine upload dist/*

  # ── Tag Go module ────────────────────────────────────────────────────────
  publish-go:
    name: Tag Go module
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go/go.mod

      - name: Test
        working-directory: go
        run: go test -v -race ./...

      # Go modules are versioned via git tags — no registry publish needed.
      # The tag pushed to this repo (vX.Y.Z) is sufficient.

  # ── Publish Java to Maven Central ────────────────────────────────────────
  publish-java:
    name: Publish Java → Maven Central
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Build, test & publish
        working-directory: java
        env:
          ORG_GRADLE_PROJECT_sonatypeUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_sonatypePassword: ${{ secrets.SONATYPE_PASSWORD }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}
        run: |
          sed -i "s/version = '.*'/version = '${{ needs.sync-version.outputs.semver }}'/" build.gradle
          ./gradlew build test publishToSonatype --no-daemon

  # ── Notify Packagist (PHP) ───────────────────────────────────────────────
  publish-php:
    name: Notify Packagist (PHP)
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4

      - name: Notify Packagist
        if: ${{ secrets.PACKAGIST_TOKEN != '' }}
        run: |
          curl -XPOST \
            -H "Content-Type: application/json" \
            "https://packagist.org/api/update-package?username=${{ secrets.PACKAGIST_USERNAME }}&apiToken=${{ secrets.PACKAGIST_TOKEN }}" \
            -d '{"repository":{"url":"https://github.com/Ucotron/sdks"}}'

  # ── Create GitHub Release ────────────────────────────────────────────────
  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs:
      - sync-version
      - publish-typescript
      - publish-python
      - publish-go
      - publish-java
      - publish-php
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release notes
        id: notes
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | head -2 | tail -1)
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "${{ env.VERSION }}" ]; then
            echo "body=Initial release of Ucotron SDKs ${{ needs.sync-version.outputs.semver }}" >> "$GITHUB_OUTPUT"
          else
            NOTES=$(git log "${PREV_TAG}..HEAD" --pretty=format:"- %s" --no-merges | head -30)
            echo "body<<EOF" >> "$GITHUB_OUTPUT"
            echo "## Changes since ${PREV_TAG}" >> "$GITHUB_OUTPUT"
            echo "" >> "$GITHUB_OUTPUT"
            echo "${NOTES}" >> "$GITHUB_OUTPUT"
            echo "" >> "$GITHUB_OUTPUT"
            echo "### Packages" >> "$GITHUB_OUTPUT"
            echo "- **npm**: \`@ucotron/sdk@${{ needs.sync-version.outputs.semver }}\`" >> "$GITHUB_OUTPUT"
            echo "- **PyPI**: \`ucotron-sdk==${{ needs.sync-version.outputs.semver }}\`" >> "$GITHUB_OUTPUT"
            echo "- **Go**: \`github.com/ucotron/ucotron-go@${{ env.VERSION }}\`" >> "$GITHUB_OUTPUT"
            echo "- **Maven**: \`com.ucotron:ucotron-sdk:${{ needs.sync-version.outputs.semver }}\`" >> "$GITHUB_OUTPUT"
            echo "- **Packagist**: \`ucotron/sdk:${{ needs.sync-version.outputs.semver }}\`" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ env.VERSION }}" \
            --title "Ucotron SDKs ${{ needs.sync-version.outputs.semver }}" \
            --notes "${{ steps.notes.outputs.body }}"
