# =============================================================================
# SDKs Release â€” Publish all SDKs on version tag
# =============================================================================
# Triggered by pushing a version tag (e.g. v0.2.0).
# Runs tests and publishes to registries, then creates a GitHub Release.
#
# Required secrets:
#   NPM_TOKEN, PYPI_API_TOKEN, SONATYPE_USERNAME, SONATYPE_PASSWORD,
#   GPG_SIGNING_KEY, GPG_SIGNING_PASSWORD, PACKAGIST_USERNAME, PACKAGIST_TOKEN

name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

env:
  VERSION: ${{ github.ref_name }}

jobs:
  sync-version:
    name: Sync version
    runs-on: ubuntu-latest
    outputs:
      semver: ${{ steps.parse.outputs.semver }}
    steps:
      - uses: actions/checkout@v4
      - name: Parse version from tag
        id: parse
        run: |
          SEMVER="${VERSION#v}"
          echo "semver=${SEMVER}" >> "$GITHUB_OUTPUT"
          echo "Release version: ${SEMVER}"

  publish-typescript:
    name: Publish TypeScript
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org
      - name: Set version and publish
        working-directory: typescript
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm version "${{ needs.sync-version.outputs.semver }}" --no-git-tag-version
          npm ci
          npm run build
          npm run test:ci
          npm publish --access public

  publish-python:
    name: Publish Python
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Build and publish
        working-directory: python
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          sed -i "s/version = \".*\"/version = \"${{ needs.sync-version.outputs.semver }}\"/" pyproject.toml
          pip install build twine
          pip install -e ".[dev]"
          pytest --tb=short
          python -m build
          twine upload dist/*

  publish-go:
    name: Tag Go module
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go/go.mod
      - name: Test
        working-directory: go
        run: go test -v -race ./...

  publish-java:
    name: Publish Java
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
      - name: Build and publish
        working-directory: java
        env:
          ORG_GRADLE_PROJECT_sonatypeUsername: ${{ secrets.SONATYPE_USERNAME }}
          ORG_GRADLE_PROJECT_sonatypePassword: ${{ secrets.SONATYPE_PASSWORD }}
          ORG_GRADLE_PROJECT_signingKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingPassword: ${{ secrets.GPG_SIGNING_PASSWORD }}
        run: |
          sed -i "s/version = '.*'/version = '${{ needs.sync-version.outputs.semver }}'/" build.gradle
          ./gradlew build test publishToSonatype --no-daemon

  publish-php:
    name: Notify Packagist
    runs-on: ubuntu-latest
    needs: sync-version
    steps:
      - uses: actions/checkout@v4
      - name: Notify Packagist
        if: ${{ secrets.PACKAGIST_TOKEN != '' }}
        run: |
          curl -XPOST \
            -H "Content-Type: application/json" \
            "https://packagist.org/api/update-package?username=${{ secrets.PACKAGIST_USERNAME }}&apiToken=${{ secrets.PACKAGIST_TOKEN }}" \
            -d '{"repository":{"url":"https://github.com/Ucotron/sdks"}}'

  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    if: always()
    needs:
      - sync-version
      - publish-typescript
      - publish-python
      - publish-go
      - publish-java
      - publish-php
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SEMVER="${{ needs.sync-version.outputs.semver }}"
          gh release create "$VERSION" \
            --title "Ucotron SDKs ${SEMVER}" \
            --generate-notes
